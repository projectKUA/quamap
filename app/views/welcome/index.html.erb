<html>
<head>
	<title>The Qua Map - Qua/Spa infomation!</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
	<script src="http://malsup.github.com/jquery.form.js"></script>
	<link rel="stylesheet" href="http://getbootstrap.com/dist/css/bootstrap.min.css" />
	<%= javascript_include_tag "jquery.popupoverlay" %>
	<%= javascript_include_tag "jquery.raty" %>
	<%= javascript_include_tag "googlemap" %>
	<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css">
	<style>
	div.window_comment, span.window_comment{
		border: 1px #AAAAAA none;
		border-collapse: collapse;
		padding: 5px 8px 8px 5px;
	}
	div #review_dialog{
		overflow: scroll;
		width: 70%;
		height: 75%;
		transition: all 0.3s;
	}
	</style>
	<script type="text/javascript">
	function reviewLinkClicked(link){
		(function($){
			$(function() {
				var qua_id = $(link).attr("id").substr(17);	// link.id = "link_show_review_xxx", and qua_id = xxx.
				$.ajax({
					url: "reviews/list_by_qua",
					type: 'get',
					data: "qua_id=" + qua_id,
					dataType: "json",
					success: function(data) {
						var qua = data.quas;			// 温泉 自分自身が1件入っている
						var reviews = data.reviews;	// 空配列の可能性もある
						createReviewDialog(qua, reviews);
					}
				});
			});
		})(jQuery);
	}
	function createReviewDialog(qua, reviews){
		(function($){
			$(function() {

				// 画面タイトル
				// replaceItem(".review-top","review_qua_title", "h2", qua.name);
				$("#review_qua_title").remove();
				if(qua.name !== null){
					$(".review-top").append('<h2 id="review_qua_title">' + qua.name + '</h2>');
				}

				// トップ画像
				// replaceImgItem(".review-top", "review_qua_img", ("/quas/" + qua.id + "/show_image") );
				$("#review_qua_img").remove();
				if(qua.image1 !== null){
					$(".review-top").append('<img id="review_qua_img" src="/quas/' + qua.id + '/show_image">');
				}else{
					$(".review-top").append('<%= image_tag('onsen.png', id:'review_qua_img', alt:'No image') %>');
				}
				// 泉質
				replaceItem("#review_qua_quality_item","review_qua_quality_value", "span", qua.quality);

				// 効能
				replaceItem("#review_qua_effect_item","review_qua_effect_value","span", qua.quality);

				// URL
				replaceItem("#review_qua_url_item","review_qua_url_value","span", "<a href='" + qua.url + "' target='_blank'>" + qua.url + "</a>");

				// 宿泊の要不要（ → 施設区分）
				replaceItem("#review_qua_category_item","review_qua_category_value", "span", (qua.stay_required ? '要宿泊' : '宿泊不要'));

				// 価格
				replaceItem("#review_qua_price_item","review_qua_price_value", "span", (qua.price === null ? "不明" : qua.price + "円" ));

				// 平均評価
				// reviewsの総合評価の平均値を求め、評価として表示する

				// レビュー記事を作成する
				// 件数を出したり、「ありません」とか出したりしたい
				replaceItem(".review_body","review_body_top", "h3", qua.name + "の記事一覧"  );
				// 表示していたレビューを（あれば）消す
				$("#review_contents").remove();
				// レビューコンテンツ基底クラスを追加する
				$("#review_body_top").after("<div id='review_contents'> </div>");
				reviews.forEach(function(review, index, reviews) {
					createReviewItem(review);
				});

			});
		})(jQuery);
	}
	/** 文字列コンテンツを配下に持つ要素タグを挿入する。*/
	function replaceItem(parent, element, tag, item){
		(function($){
			$(function() {
				$("#" + element).remove();
				if(item !== null){
					$(parent).append('<' + tag + ' id="' + element + '">' + item + '</' + tag + '>');
				}
			});
		})(jQuery);
	}

	/** レビューもしくは記事１件をビルドする。 */
	function createReviewItem(review){
		(function($){
			$(function() {
				// レビューか記事かで記述内容を替える
				// total_scoreが入っていたらレビューと見なす
				if(review.total_score !== null){
					createReviewItemReview(review);
				}else{
					createReviewItemContent(review);
				}
			});
		})(jQuery);
	}
	/** レビュー１件をビルドする。 */
	function createReviewItemReview(review){
		(function($){
			$(function() {
				var id = 'review_content_' + review.id;
				// 基底タグ idにreview.id(review_content_xxx)を格納する
				$("#review_contents").append('<div id="' + id +'"></div>').append(
					// イメージ
					'<img class="review-image" src="./resized_DSC_0339.jpg" />').append(
					// タイトル
					'<div id="review_title_' + review.id + '"><h4>' + review.title + '</h4></div>').append(
					// 名前
					'<div id="review_title_' + review.id + '"><span>名前：<a href="mailto:' + review.email +'">' + review.nickname + '</a></span></div>');



				// 投稿日時


				// 総合評価


				// 泉質


				// 行きやすさ・使いやすさ

				// 価格

				// 景観 / その他

				// コメント

			});
		})(jQuery);
	}
	/** 記事１件をビルドする。 */
	function createReviewItemContent(review){
		(function($){
			$(function() {
				var id = 'review_content_' + review.id;
				// 基底タグ idにreview.id(review_content_xxx)を格納する
				$("#review_contents").append('<div id="' + id +'"></div>').append(
					// イメージ
					'<img class="review-image" src="./resized_DSC_0339.jpg" />').append(
					// タイトル
					'<div id="review_title_' + review.id + '"><h4>' + review.title + '</h4></div>').append(
					// 名前
					'<div id="review_title_' + review.id + '"><span>名前：<a href="mailto:' + review.email +'">' + review.nickname + '</a></span></div>');

				// 投稿日時

				// コメント

			});
		})(jQuery);
	}

	// google map object
	var mapObj;
    function getQuaDialogString(id, name, quality, effect, stay_required, price, url, image_caption, image){
    	var ret =
    	  '<div id="content_qua_' + id + '" class="info_window">'+
    	  '<div id="siteNotice"></div>' +
    	   image +
    	  '<div class="firstheading"><h1 id="firstHeading">' + name + '</h1></div>'+
    	  '<div style="clear: both;"></div>' +
    	  '<div id="bodyContent" class="min-width:450px; width: 100%; clear: both;">'+
    	  '<p style="white-space: nowrap;"><b>泉質:</b>' + quality + '</p>'+
    	  '<p><b>効能:</b>' + effect + '</p>'+
    	  '<p><b>宿泊の必要:</b>' + (stay_required ? '有' : '無') + '</p>'+
    	  '<p><b>料金:</b>' + (price === "" ? "不明" : price + "円" ) + '</p>';
				if(url !== ''){
					ret += '<p style="white-space: nowrap;"><a href="' + url + '" target="_brank"><b>Website</b></a></p>';
				}else{
					ret += '<p style="white-space: nowrap;"><b>No Website</b></a></p>';
				}
				ret += '</div>';	// end of 'bodyContent'
				// ret += '<div><button id="link_show_review_' + id + '" class="btn btn-sm btn-link review_dialog_open">レビューを見る</button></div>';
				ret += '<div><button id="link_show_review_' + id + '" class="btn btn-sm btn-link review_dialog_open" onclick="reviewLinkClicked(this)">レビューを見る</button></div>';
				ret += '</div>';	// end of 'content_qua_xxx'
    	  '</div></div>';
    	return ret;
    }
	// 温泉情報　名称,緯度,経度,泉質,効能
    var stations = [
        <% @quas.each do |q| %>
	    [ '<%= q.id %>', '<%= q.name %>', <%= q.latitude %>, <%= q.longitude %>,'<%= q.quality.html_safe %>',
	    '<%= q.effect.html_safe %>', '<%= q.stay_required %>', '<%= q.price %>', '<%= q.url %>', '<%= q.image1_caption %>',
	    '<%= q.image1.present? ? image_tag(show_image_qua_path(q), class:'img_info_window', alt:'No image') : image_tag('onsen.png', class:'img_info_window', alt:'No image') %>'] <%= ", " unless q == @quas.last %>
        <% end %>
    ];

	// マーカーを作成
	var icon = new google.maps.MarkerImage('http://docs.google.com/uc?export=view&id=0B15A7hRyx7EIVjJTNkZpYjJGQlk',
		// This marker is 20 pixels wide by 32 pixels tall.
		new google.maps.Size(24, 24),
		// The origin for this image is 0,0.
		new google.maps.Point(0,0),
		// The anchor for this image is the base of the flagpole at 0,32.
		new google.maps.Point(0, 24)
	);
	function entryMapIcon(id, title, lat, lng, quality, effect, stay_required, price, url, image_caption, image, disp){
			var latlng = new google.maps.LatLng(lat, lng);
			var marker = new google.maps.Marker({
				position: latlng,
				map: mapObj,
				title: title,
				icon: icon
			});
			var infowindow = new google.maps.InfoWindow({
				content: getQuaDialogString(id, title, quality, effect, stay_required, price, url, image_caption, image)
			});
			google.maps.event.addListener(marker, 'click', function() {
			  infowindow.open(mapObj,marker);
			});
			if(disp){
			  infowindow.open(mapObj,marker);
			}
	}
	(function($){
		$(function() {
			function mapClicked(e){
				$("#qua_latitude").val(e.latLng.lat());
				$("#qua_longitude").val(e.latLng.lng());
			}
			function  displayMap(){
				var center = new google.maps.LatLng(<%= @center.latitude %>, <%= @center.longitude %>);
				var mapOptions = {
					zoom: 14,
					center: center,
					mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style'],
					scaleControl: true
				};
				mapObj = new google.maps.Map(document.getElementById('gmap'), mapOptions);

				// Create a new StyledMapType object, passing it the array of styles,
				// as well as the name to be displayed on the map type control.
				var styledMap = new google.maps.StyledMapType(styles,
					{name: "Styled Map"});
				//Associate the styled map with the MapTypeId and set it to display.
				mapObj.mapTypes.set('map_style', styledMap);
				mapObj.setMapTypeId('map_style');

				$.each(stations, function(){
                    var eps = 1e-6;
					entryMapIcon(this[0], this[1], this[2], this[3], this[4], this[5], this[6], this[7], this[8], this[9],
						this[10],
					    this[2] - eps < center.lat() && center.lat() < this[2] + eps
					    && this[3] - eps < center.lng() && center.lng() < this[3] + eps );
				});
				var kmlLayer = new google.maps.KmlLayer({
					driveFileId: "0B2w7buxyq8qvU3hCZzFfWTFkajQ",
					preserveViewport: true
				});
				kmlLayer.setMap(mapObj);
				google.maps.event.addListener(mapObj, 'click', mapClicked);
			};
			google.maps.event.addDomListener(window, 'load', displayMap);
			$('#review_dialog').popup({
				traisition: '0.3s all',
				opacity: 0.3
			});
			$("#buttonEntryQua").click(function(){
				$("#dialog").dialog(
					{ buttons: [{
						text: "登録", click: function() {
							// #new_quaにsubmitを行なう。
							// 実行後にwelcome/index.html.erbを再表示する。
							$("#new_qua").ajaxSubmit(function(data) {
									var qua = data.qua;
									var image = qua.image1 == null ? '<img class="img_info_window" src="/assets/onsen.png">' : '<img class="img_info_window" src="/quas/' + qua.id + '/show_image">'
									entryMapIcon(qua.id, qua.name, qua.latitude, qua.longitude, qua.quality, qua.effect,
										qua.stay_required, qua.price, qua.url, qua.image1_caption, image , true);
									$("#dialog").dialog( "close" );
							});
						}
					},{
						text: "キャンセル", click: function() {
							$(this).dialog( "close" );
						}
					}
				]});
			});
		});
	})(jQuery);
	</script>
</head>
<body>
	<div id="wrapper" style="width: 100%; height: 100%;">
		<h1>The QUA Map</h1>
		<p>日本温泉マップ</p>
		<div id="gmap" style="width: 99%; height: 500px; border: 1px solid Gray;">
		</div>
		<div>
			<br />
			<button id='buttonEntryQua' type='button' class='btn btn-sm btn-default'>温泉を登録する</button>
			<br />
			<a href='/quas' target='_blank'>Quas</button>
			<br />
			<a href='/reviews' target='_blank'>Reviews</button>
		</div>
		<%= render 'qua_entry_dialog' %>
		<%= render 'review_dialog' %>
	</div>
</body>
</html>
