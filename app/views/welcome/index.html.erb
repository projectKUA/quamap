<html>
<head>
	<title>The Qua Map - Qua/Spa infomation!</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
	<%= javascript_include_tag "googlemap" %>
	<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css">
	<script type="text/javascript">
	// google map object
	var mapObj
    function getQuaDialogString(id, name, quality, effect, stay_required, price, url, image_caption, image){
    	var ret =
    	  '<div id="content_qua_' + id + '">'+
    	  '<div id="siteNotice"></div>'+
    	  '<h1 id="firstHeading" class="firstHeading" style="white-space: nowrap;">' + name + '</h1>'+
    	  '<div id="bodyContent">'+
    	  '<p style="white-space: nowrap;"><b>泉質:</b>' + quality + '</p>'+
    	  '<p><b>効能:</b>' + effect + '</p>'+
    	  '<p><b>宿泊の必要:</b>' + (stay_required ? '有' : '無') + '</p>'+
    	  '<p><b>料金:</b>' + price + '</p>'+
    	  '<p style="white-space: nowrap;"><b>HP:</b><a href="' + url + '" target="_brank">' + url + '</a></p>' +
    	  '<p>' + image_caption + '</p>'+
    	  '<p>' + image + '</p>' +
    	  '</div></div>';
    	return ret;
    }
	// 温泉情報　名称,緯度,経度,泉質,効能
    var stations = [
        <% @quas.each do |q| %>
	    [ '<%= q.id %>', '<%= q.name %>', <%= q.latitude %>, <%= q.longitude %>,'<%= q.quality.html_safe %>', '<%= q.effect.html_safe %>', '<%= q.stay_required %>', '<%= q.price %>', '<%= q.url %>', '<%= q.image1_caption %>', '<%= image_tag show_image_qua_path(q), class:'qua-img', alt:'No image' %>'] <%= ", " unless q == @quas.last %>
        <% end %>
    ];

	// マーカーを作成
	var icon = new google.maps.MarkerImage('http://docs.google.com/uc?export=view&id=0B15A7hRyx7EIVjJTNkZpYjJGQlk',
		// This marker is 20 pixels wide by 32 pixels tall.
		new google.maps.Size(24, 24),
		// The origin for this image is 0,0.
		new google.maps.Point(0,0),
		// The anchor for this image is the base of the flagpole at 0,32.
		new google.maps.Point(0, 24)
	);
	function entryMapIcon(id, title, lat, lng, quality, effect, stay_required, price, url, image_caption, image, disp){
			var latlng = new google.maps.LatLng(lat, lng);
			var marker = new google.maps.Marker({
				position: latlng,
				map: mapObj,
				title: title,
				icon: icon
			});
			var infowindow = new google.maps.InfoWindow({
				content: getQuaDialogString(id, title, quality, effect, stay_required, price, url, image_caption, image)
			});
			google.maps.event.addListener(marker, 'click', function() {
			  infowindow.open(mapObj,marker);
			});
			if(disp){
			  infowindow.open(mapObj,marker);
			}
	}
	(function($){
		$(function() {

			function mapClicked(e){
				$("#qua_latitude").val(e.latLng.lat());
				$("#qua_longitude").val(e.latLng.lng());
			}
			function  displayMap(){
				var center = new google.maps.LatLng(<%= @center.latitude %>, <%= @center.longitude %>);
				var mapOptions = {
					zoom: 14,
					center: center,
					mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style'],
					scaleControl: true
				};
				mapObj = new google.maps.Map(document.getElementById('gmap'), mapOptions);

				// Create a new StyledMapType object, passing it the array of styles,
				// as well as the name to be displayed on the map type control.
				var styledMap = new google.maps.StyledMapType(styles,
					{name: "Styled Map"});
				//Associate the styled map with the MapTypeId and set it to display.
				mapObj.mapTypes.set('map_style', styledMap);
				mapObj.setMapTypeId('map_style');

				$.each(stations, function(){
                    var eps = 1e-6;
					entryMapIcon(this[0], this[1], this[2], this[3], this[4], this[5], this[6], this[7], this[8], this[9], 
						this[10], 
					    this[2] - eps < center.lat() && center.lat() < this[2] + eps 
					    && this[3] - eps < center.lng() && center.lng() < this[3] + eps );
				});
				var kmlLayer = new google.maps.KmlLayer({
					driveFileId: "0B2w7buxyq8qvU3hCZzFfWTFkajQ",
					preserveViewport: true
				});
				kmlLayer.setMap(mapObj);
				google.maps.event.addListener(mapObj, 'click', mapClicked);
			};
			google.maps.event.addDomListener(window, 'load', displayMap);

			$("#buttonEntryQua").click(function(){
				$("#dialog").dialog(
					{ buttons: [{
						text: "登録", click: function() {
							// #new_qusubmitを行なう。
							// 実行後にwelcome/index.html.erbを再表示する。
							// $("#new_qua").ajax(  );
							$.ajax({
								url: $("#new_qua").attr('action'),
								type: $("#new_qua").attr('method'),
								data: $("#new_qua").serialize(),
								dataType: "json",
								success: function(data) {
									var qua = data.qua;
									var image = '<img alt="No image" src="/quas/' + qua.id + '/show_image">'
									entryMapIcon(qua.id, qua.name, qua.latitude, qua.longitude, qua.quality, qua.effect, 
										qua.stay_required, qua.price, qua.url, qua.image1_caption, image , true);
									$("#dialog").dialog( "close" );
								}
							});
						}
					},{
						text: "キャンセル", click: function() {
							$(this).dialog( "close" );
						}
					}
				]});
			});
		});
	})(jQuery);
	</script>
</head>
<body>
	<h1>The QUA Map</h1>
	<p>日本温泉マップ</p>
	<div id="gmap" style="width: 99%; height: 500px; border: 1px solid Gray;">
	</div>
	<div>
		<br />
		<button id='buttonEntryQua' type='button'>温泉を登録する</button>
		<br />
		<a href='/quas' target='_blank'>Quas</button>
		<br />
		<a href='/reviews' target='_blank'>Reviews</button>
	</div>
<%= render 'qua_entry_dialog' %>
</body>
</html>
